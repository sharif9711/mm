<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì£¼ì†Œ(ë„ë¡œëª…+ì§€ë²ˆ)ìœ¼ë¡œ ë§ˆì»¤ ë° í•„ì§€ ì™¸ê³½ì„  í‘œì‹œ</title>

<!-- OpenLayers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.2/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v7.5.2/dist/ol.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
body { font-family: sans-serif; background:#f4f4f9; margin:0; padding:20px; }
#map { width:100%; height:600px; border-radius:10px; border:1px solid #ccc; }
input[type=text]{ padding:6px; width:300px; }
button{ padding:6px 10px; cursor:pointer; }
</style>
</head>

<body>
<h2>ğŸ“ ë„ë¡œëª…ì£¼ì†Œ + ì§€ë²ˆì£¼ì†Œ ì…ë ¥ìœ¼ë¡œ ë§ˆì»¤ ë° í•„ì§€ ì™¸ê³½ì„  í‘œì‹œ</h2>
<p>ì˜ˆì‹œ1: ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì‚¬ì§ë¡œ 161<br>ì˜ˆì‹œ2: ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬ ì‹ êµë™ 1-1</p>
<input type="text" id="addressInput" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
<button id="searchBtn">ê²€ìƒ‰</button>

<div id="map"></div>

<script>
const API_KEY = "BE552462-0744-32DB-81E7-1B7317390D68";

// ê¸°ë³¸ ì§€ë„
const baseLayer = new ol.layer.Tile({
  source: new ol.source.XYZ({
    url: `https://api.vworld.kr/req/wmts/1.0.0/${API_KEY}/Base/{z}/{y}/{x}.png`
  })
});

const view = new ol.View({
  center: [14135244, 4518296],
  zoom: 7
});

const map = new ol.Map({
  target: "map",
  layers: [baseLayer],
  view: view
});

let markerLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
let polygonLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
map.addLayer(markerLayer);
map.addLayer(polygonLayer);

const markerStyle = new ol.style.Style({
  image: new ol.style.Icon({
    src: 'http://map.vworld.kr/images/ol3/marker_blue.png',
    anchor: [0.5, 1]
  })
});

const polygonStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({ color: 'rgba(0,128,255,0.9)', width: 3 }),
  fill: new ol.style.Fill({ color: 'rgba(0,128,255,0.2)' })
});

// ì£¼ì†Œ ìœ í˜• ê°ì§€: ì§€ë²ˆì£¼ì†ŒëŠ” ëŒ€ë¶€ë¶„ ìˆ«ì+â€œ-â€ê°€ ìˆìŒ
function detectAddressType(address) {
  const regex = /\d+-?\d*/;
  return regex.test(address) ? "parcel" : "road";
}

function searchAddress(address) {
  const addrType = detectAddressType(address);

  $.ajax({
    url: "https://api.vworld.kr/req/address",
    dataType: "jsonp",
    data: {
      service: "address",
      request: "getcoord",
      version: "2.0",
      format: "json",
      type: addrType,
      key: API_KEY,
      address: address
    },
    success: function(data) {
      if (!data.response || data.response.status === "NOT_FOUND") {
        // ì²« ì‹œë„ ì‹¤íŒ¨ ì‹œ, ë‹¤ë¥¸ íƒ€ì…ìœ¼ë¡œ ì¬ì‹œë„
        if (addrType === "road") retryAddress(address, "parcel");
        else retryAddress(address, "road");
        return;
      }
      const result = data.response.result.point;
      const x = parseFloat(result.x);
      const y = parseFloat(result.y);
      showMarkerAndPolygon(x, y);
    },
    error: function() {
      alert("ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });
}

function retryAddress(address, retryType) {
  $.ajax({
    url: "https://api.vworld.kr/req/address",
    dataType: "jsonp",
    data: {
      service: "address",
      request: "getcoord",
      version: "2.0",
      format: "json",
      type: retryType,
      key: API_KEY,
      address: address
    },
    success: function(data) {
      if (!data.response || data.response.status === "NOT_FOUND") {
        alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const result = data.response.result.point;
      const x = parseFloat(result.x);
      const y = parseFloat(result.y);
      showMarkerAndPolygon(x, y);
    }
  });
}

function showMarkerAndPolygon(x, y) {
  markerLayer.getSource().clear();
  polygonLayer.getSource().clear();

  const marker = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat([x, y]))
  });
  marker.setStyle(markerStyle);
  markerLayer.getSource().addFeature(marker);

  map.getView().animate({ center: ol.proj.fromLonLat([x, y]), zoom: 18 });

  getParcelPolygon(x, y);
}

function getParcelPolygon(lon, lat) {
  const point3857 = ol.proj.transform([lon, lat], "EPSG:4326", "EPSG:900913");
  const geomfilter = `POINT(${point3857[0]} ${point3857[1]})`;

  const params = {
    key: API_KEY,
    service: "data",
    version: "2.0",
    request: "getfeature",
    format: "json",
    size: "10",
    page: "1",
    data: "LP_PA_CBND_BUBUN",
    geometry: "true",
    attribute: "true",
    crs: "EPSG:3857",
    geomfilter: geomfilter
  };

  $.ajax({
    url: "https://api.vworld.kr/req/data",
    data: params,
    dataType: "jsonp",
    success: function(data) {
      if (!data.response || !data.response.result || !data.response.result.featureCollection) {
        alert("í•„ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const features = new ol.format.GeoJSON().readFeatures(data.response.result.featureCollection);
      features.forEach(f => f.setStyle(polygonStyle));
      polygonLayer.getSource().addFeatures(features);
    },
    error: function() {
      alert("í•„ì§€ ì™¸ê³½ì„  í‘œì‹œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });
}

$("#searchBtn").on("click", function() {
  const addr = $("#addressInput").val().trim();
  if (addr === "") {
    alert("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }
  searchAddress(addr);
});
</script>
</body>
</html>
