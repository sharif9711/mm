<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>주소로 마커 및 필지 외곽선 표시</title>

<!-- OpenLayers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.5.2/ol.css">
<script src="https://cdn.jsdelivr.net/npm/ol@v7.5.2/dist/ol.js"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
body { font-family: sans-serif; background:#f4f4f9; margin:0; padding:20px; }
#map { width:100%; height:600px; border-radius:10px; border:1px solid #ccc; }
input[type=text]{ padding:6px; width:300px; }
button{ padding:6px 10px; cursor:pointer; }
</style>
</head>

<body>
<h2>📍 주소 입력으로 마커 + 필지 외곽선 표시</h2>
<p>예시: 서울특별시 종로구 사직로 161</p>
<input type="text" id="addressInput" placeholder="주소를 입력하세요">
<button id="searchBtn">검색</button>

<div id="map"></div>

<script>
const API_KEY = "BE552462-0744-32DB-81E7-1B7317390D68";

const baseLayer = new ol.layer.Tile({
  source: new ol.source.XYZ({
    url: `https://api.vworld.kr/req/wmts/1.0.0/${API_KEY}/Base/{z}/{y}/{x}.png`
  })
});

const view = new ol.View({
  center: [14135244, 4518296],
  zoom: 7
});

const map = new ol.Map({
  target: "map",
  layers: [baseLayer],
  view: view
});

// 마커와 폴리곤 레이어 생성
let markerLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
let polygonLayer = new ol.layer.Vector({ source: new ol.source.Vector() });
map.addLayer(markerLayer);
map.addLayer(polygonLayer);

// 마커 스타일
const markerStyle = new ol.style.Style({
  image: new ol.style.Icon({
    src: 'http://map.vworld.kr/images/ol3/marker_blue.png',
    anchor: [0.5, 1]
  })
});

// 폴리곤 스타일
const polygonStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({ color: 'rgba(0,128,255,0.9)', width: 3 }),
  fill: new ol.style.Fill({ color: 'rgba(0,128,255,0.2)' })
});

function searchAddress(address) {
  $.ajax({
    url: "https://api.vworld.kr/req/address",
    dataType: "jsonp",
    data: {
      service: "address",
      request: "getcoord",
      version: "2.0",
      format: "json",
      type: "road",   // 도로명 기반
      key: API_KEY,
      address: address
    },
    success: function(data) {
      if (!data.response || data.response.status === "NOT_FOUND") {
        alert("주소를 찾을 수 없습니다.");
        return;
      }

      const result = data.response.result.point;
      const x = parseFloat(result.x);
      const y = parseFloat(result.y);
      console.log("좌표:", x, y);
      showMarkerAndPolygon(x, y);
    },
    error: function() {
      alert("주소 검색 중 오류가 발생했습니다.");
    }
  });
}

function showMarkerAndPolygon(x, y) {
  // 마커 표시
  markerLayer.getSource().clear();
  const marker = new ol.Feature({
    geometry: new ol.geom.Point(ol.proj.fromLonLat([x, y]))
  });
  marker.setStyle(markerStyle);
  markerLayer.getSource().addFeature(marker);

  // 지도 이동
  map.getView().animate({ center: ol.proj.fromLonLat([x, y]), zoom: 18 });

  // 필지 외곽선 조회
  getParcelPolygon(x, y);
}

function getParcelPolygon(lon, lat) {
  polygonLayer.getSource().clear();

  // EPSG:4326 → EPSG:900913 변환
  const point3857 = ol.proj.transform([lon, lat], "EPSG:4326", "EPSG:900913");
  const geomfilter = `POINT(${point3857[0]} ${point3857[1]})`;

  const dataParams = {
    key: API_KEY,
    service: "data",
    version: "2.0",
    request: "getfeature",
    format: "json",
    size: "10",
    page: "1",
    data: "LP_PA_CBND_BUBUN",
    geometry: "true",
    attribute: "true",
    crs: "EPSG:3857",
    geomfilter: geomfilter
  };

  $.ajax({
    url: "https://api.vworld.kr/req/data",
    data: dataParams,
    dataType: "jsonp",
    success: function(data) {
      if (!data.response || !data.response.result || !data.response.result.featureCollection) {
        alert("필지 데이터를 불러올 수 없습니다.");
        return;
      }

      const geojson = new ol.format.GeoJSON().readFeatures(data.response.result.featureCollection);
      geojson.forEach(f => f.setStyle(polygonStyle));
      polygonLayer.getSource().addFeatures(geojson);
    },
    error: function() {
      alert("필지 조회 중 오류가 발생했습니다.");
    }
  });
}

$("#searchBtn").on("click", function() {
  const addr = $("#addressInput").val().trim();
  if (addr === "") {
    alert("주소를 입력하세요.");
    return;
  }
  searchAddress(addr);
});
</script>
</body>
</html>
