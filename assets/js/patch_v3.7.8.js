/*! v3.7.8 compact patch */
(function(){const ORIG=window.buildMapHTML;function esc(s){return String(s).replace(/<\/script>/gi,'<\\/script>')}
window.buildMapHTML=function(title,rows){try{const T=(title||'지도').replace(/[<>]/g,s=>({'<':'&lt;','>':'&gt;'}[s]));const D=esc(JSON.stringify(rows||[]));
const H='<!doctype html><html lang=ko><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"/>'+
'<title>'+T+' - 지도</title><style>:root{--bg:#f7fafc;--glass:#ffffffaa;--blur:12px;--b:#e5e7eb;--on:#1d4ed8;--on-text:#fff;--off:#fff;--off-b:#cbd5e1;--text:#0f172a}*{box-sizing:border-box}html,body{height:100%}body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg)}.app-header{position:sticky;top:0;z-index:10;display:flex;justify-content:center;align-items:center;padding:8px;border-bottom:1px solid var(--b);backdrop-filter:saturate(180%) blur(var(--blur));background:var(--glass)}.controls{display:flex;gap:6px;flex-wrap:wrap}.btn{border:1px solid var(--off-b);border-radius:999px;background:#fff;padding:6px 10px;cursor:pointer}.btn[aria-pressed=true]{background:var(--on);border-color:var(--on);color:#fff}main{height:calc(100% - 54px)}#map{height:100%;width:100%}.info-card{position:absolute;left:12px;bottom:12px;min-width:260px;max-width:340px;background:var(--glass);backdrop-filter:blur(var(--blur));border:1px solid var(--b);border-radius:14px;padding:10px}.info-card.hidden{display:none}.row{display:flex;gap:6px;margin:6px 0}.label-capsule{display:inline-flex;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.35);border:1px solid rgba(255,255,255,.5)}.badge{display:inline-flex;justify-content:center;align-items:center;min-width:26px;min-height:26px;padding:2px 8px;border-radius:999px;color:#fff;font-weight:700}.badge.blue{background:#2563eb}.badge.black{background:#111827}.badge.gray{background:#6b7280}.kmap-label{position:absolute;transform:translate(-50%,-50%)}.arrow{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:10px solid #1f2937;opacity:.8}.guide{position:absolute;right:12px;bottom:12px;width:300px;max-height:40vh;overflow:auto;background:var(--glass);border:1px solid var(--b);border-radius:12px;padding:10px}</style>'+
'<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=cdad276f68285333fba23b841fb49970&libraries=services"></'+'script></head>'+
'<body><header class=app-header><div class=controls>'+
'<button id=btnMy class=btn aria-pressed=false>GPS</button>'+
'<button id=btnAll class=btn aria-pressed=true>전체</button>'+
'<button id=btnPlan class=btn aria-pressed=false>예정</button>'+
'<button id=btnDone class=btn aria-pressed=false>완료</button>'+
'<button id=btnHold class=btn aria-pressed=false>보류</button>'+
'<button id=btnRoute class=btn aria-pressed=false>최적경로</button>'+
'<button id=btnClear class=btn aria-pressed=false>지우기</button>'+
'<button id=btnMapType class=btn aria-pressed=false>지도</button>'+
'</div></header><main><div id=map></div><div id=card class="info-card hidden" role=dialog aria-live=polite></div><div id=guide class=guide style="display:none"><h4 style="margin:0 0 6px">길 안내</h4><ol id=guideList style="margin:0;padding-left:18px"></ol></div></main>'+
'<script>(function(){"use strict";const C={"예정":"blue","완료":"black","보류":"gray"},B={blue:"blue",black:"black",gray:"gray"};const rows=JSON.parse("'+D.replace(/"/g,'\\"')+'");let map,markers=[],overlays=[],routeLine=null,routeArrows=[],myMarker=null,myLatLng=null;function setP(b,on){b.setAttribute("aria-pressed",on?"true":"false")}function clr(){markers.forEach(m=>m.marker.setMap(null));overlays.forEach(o=>o.overlay.setMap(null));markers=[];overlays=[]}function cls(s){const k=C[s]||"blue";return B[k]}function upd(idx,st){const o=overlays[idx];if(!o)return;const g=o.el.querySelector(".badge");g.classList.remove("blue","black","gray");g.classList.add(cls(st))}function card(r,idx){const d=document.getElementById("card");d.innerHTML='<div class=row><div class=title>'+ (r.no||'') +'. '+ (r.name||'') +'</div></div><div class=row><strong>주소</strong> '+ (r.addr||'') +'</div><div class=row><label for=selState><strong>상태</strong></label><select id=selState><option '+(((r.state||"예정")==="예정")?"selected":"")+'>예정</option><option '+((r.state==="완료")?"selected":"")+'>완료</option><option '+((r.state==="보류")?"selected":"")+'>보류</option></select></div>';d.classList.remove("hidden");kakao.maps.event.addListener(map,'click',()=>d.classList.add('hidden'));d.querySelector('#selState').onchange=e=>{const v=e.target.value;r.state=v;upd(idx,v)}}function mk(rows){clr();const b=new kakao.maps.LatLngBounds();const g=new kakao.maps.services.Geocoder();function add(r,ll){r._ll=ll;const k=C[r.state||"예정"]||"blue";const el=document.createElement('div');el.className='label-capsule';el.innerHTML='<span class="badge '+B[k]+'">'+(r.no||'')+'</span><span>'+(r.name||'')+'</span>';const ov=new kakao.maps.CustomOverlay({position:ll,content:el,yAnchor:1,zIndex:3});ov.setMap(map);overlays.push({overlay:ov,row:r,el:el});const m=new kakao.maps.Marker({position:ll,clickable:true});m.setMap(map);const i=overlays.length-1;markers.push({marker:m,overlay:ov,row:r,idx:i});kakao.maps.event.addListener(ov,'click',()=>card(r,i));kakao.maps.event.addListener(m,'click',()=>card(r,i))}const jobs=[];rows.forEach(r=>{if(r.lat&&r.lng){const ll=new kakao.maps.LatLng(parseFloat(r.lat),parseFloat(r.lng));b.extend(ll);add(r,ll)}else if(r.addr){jobs.push(new Promise(res=>{g.addressSearch(r.addr,(resu,s)=>{if(s===kakao.maps.services.Status.OK&&resu[0]){const ll=new kakao.maps.LatLng(parseFloat(resu[0].y),parseFloat(resu[0].x));b.extend(ll);add(r,ll)}res()})}))}});Promise.all(jobs).then(()=>{if(!b.isEmpty())map.setBounds(b)})}function mypos(auto){if(myMarker&&!auto){myMarker.setMap(null);myMarker=null;myLatLng=null;return}if(!navigator.geolocation){return}navigator.geolocation.getCurrentPosition(p=>{const {latitude,longitude}=p.coords;myLatLng=new kakao.maps.LatLng(latitude,longitude);if(!myMarker){myMarker=new kakao.maps.Marker({position:myLatLng})}else{myMarker.setPosition(myLatLng)}myMarker.setMap(map);map.setCenter(myLatLng);const b=document.getElementById('btnMy');if(b)setP(b,true)},()=>{}, {enableHighAccuracy:true,maximumAge:10000,timeout:15000})}function mtype(btn){if(map.getMapTypeId()===kakao.maps.MapTypeId.HYBRID){map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);btn.textContent='스카이'}else{map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);btn.textContent='지도'}}function clrRt(){if(routeLine){routeLine.setMap(null);routeLine=null}routeArrows.forEach(a=>a.setMap&&a.setMap(null));routeArrows=[];document.getElementById('guide').style.display='none';document.getElementById('guideList').innerHTML=''}function arrs(path,step){step=step||150;function R(x){return x*Math.PI/180}function d(a,b){const Rm=6371000,dl=R(b.getLat()-a.getLat()),dn=R(b.getLng()-a.getLng());const A=Math.sin(dl/2)**2+Math.cos(R(a.getLat()))*Math.cos(R(b.getLat()))*Math.sin(dn/2)**2;return 2*Rm*Math.asin(Math.min(1,Math.sqrt(A)))}function br(a,b){const f1=R(a.getLat()),f2=R(b.getLat()),dl=R(b.getLng()-a.getLng());const y=Math.sin(dl)*Math.cos(f2),x=Math.cos(f1)*Math.sin(f2)-Math.sin(f1)*Math.cos(f2)*Math.cos(dl);return (Math.atan2(y,x)*180/Math.PI+360)%360}let acc=0;for(let i=1;i<path.length;i++){const A=path[i-1],B=path[i],seg=d(A,B);let t=step-acc;while(t<=seg){const r=t/seg,lat=A.getLat()+(B.getLat()-A.getLat())*r,lng=A.getLng()+(B.getLng()-A.getLng())*r,ang=br(A,B);const el=document.createElement('div');el.className='kmap-label';const ar=document.createElement('div');ar.className='arrow';ar.style.transform='rotate('+ang+'deg)';el.appendChild(ar);const ov=new kakao.maps.CustomOverlay({position:new kakao.maps.LatLng(lat,lng),content:el,yAnchor:.5,zIndex:2});ov.setMap(map);routeArrows.push(ov);t+=step}acc=(seg+acc)%step}}function stepKo(s){const m=s.maneuver||{},t=m.type,md=m.modifier,dir={left:'좌회전',right:'우회전',straight:'직진',slight_left:'좌측',slight_right:'우측',uturn:'유턴'}[md||'']||'';const map={'depart':'출발','arrive':'도착','turn':dir||'회전','continue':'직진','merge':'합류','roundabout':'로터리','fork':'갈림길','end of road':'도로 끝','on ramp':'램프 진입','off ramp':'램프 종료'};let act=map[t]||'이동';if(t==='turn'&&dir)act=dir;const dist=(s.distance/1000>=1)?(s.distance/1000).toFixed(1)+'km':Math.round(s.distance)+'m';return act+' ('+dist+')'}async function route(){const pts=overlays.map(o=>o.row).filter(r=>r&&r._ll).map(r=>[r._ll.getLng(),r._ll.getLat()]);if(pts.length<2){alert('경로를 그리기 위해 최소 2개 지점이 필요합니다.');return}if(myLatLng)pts.unshift([myLatLng.getLng(),myLatLng.getLat()]);try{const cs=pts.map(p=>p[0]+','+p[1]).join(';');const tab='https://router.project-osrm.org/table/v1/driving/'+cs+'?annotations=duration';const t=await fetch(tab).then(r=>r.json());if(!t||!t.durations)throw new Error('OSRM Table 오류');const n=pts.length,u=Array(n).fill(false);let ord=[0];u[0]=true;for(let s=1;s<n;s++){const last=ord[ord.length-1];let best=-1,bv=1/0;for(let j=0;j<n;j++){if(!u[j]&&t.durations[last][j]!=null){const v=t.durations[last][j];if(v<bv){bv=v;best=j}}}if(best===-1)break;ord.push(best);u[best]=true}const ordPts=ord.map(i=>pts[i]);const url='https://router.project-osrm.org/route/v1/driving/'+ordPts.map(p=>p[0]+','+p[1]).join(';')+'?overview=full&geometries=geojson&steps=true';const r=await fetch(url).then(r=>r.json());if(!r||!r.routes||!r.routes[0])throw new Error('OSRM Route 오류');const route=r.routes[0];const coords=route.geometry.coordinates;const path=coords.map(x=>new kakao.maps.LatLng(x[1],x[0]));clrRt();routeLine=new kakao.maps.Polyline({path:path,strokeWeight:6,strokeColor:'#1d4ed8',strokeOpacity:.9,strokeStyle:'solid'});routeLine.setMap(map);arrs(path,150);const b=new kakao.maps.LatLngBounds();path.forEach(p=>b.extend(p));map.setBounds(b);const g=document.getElementById('guide'),L=document.getElementById('guideList');L.innerHTML='';route.legs.forEach(leg=>(leg.steps||[]).forEach(st=>{const li=document.createElement('li');li.textContent=stepKo(st);L.appendChild(li)}));g.style.display='block'}catch(e){console.error(e);alert('경로를 가져오지 못했습니다.')}}function UI(){const my=document.getElementById('btnMy'),rt=document.getElementById('btnRoute'),cl=document.getElementById('btnClear'),mt=document.getElementById('btnMapType');my.addEventListener('click',()=>{const on=my.getAttribute('aria-pressed')!=='true';setP(my,on);if(on)mypos();else{if(myMarker){myMarker.setMap(null);myMarker=null}}});mt.addEventListener('click',()=>{if(map.getMapTypeId()===kakao.maps.MapTypeId.HYBRID){map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);mt.textContent='스카이'}else{map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);mt.textContent='지도'}});rt.addEventListener('click',route);cl.addEventListener('click',()=>{clrRt();setP(rt,false)})}function init(){map=new kakao.maps.Map(document.getElementById('map'),{center:new kakao.maps.LatLng(37.5665,126.9780),level:6,mapTypeId:kakao.maps.MapTypeId.HYBRID});mk(rows);UI();mypos(true)};kakao.maps.load(init);})();</'+'script></body></html>';
return H;}catch(e){if(typeof ORIG==='function')return ORIG(title,rows);return '<html><body><pre>'+ (e&&e.stack||e) +'</pre></body></html>'}};})();